# Bloom filter （布隆过滤器）

布隆过滤器是一种概率数据结构，适合用于检查集合中是否存在某个元素


布隆过滤器**不存储集合中的所有元素，而是仅存储元素的散列表示。
代价是牺牲了一些精度，好处是布隆过滤器非常节省空间且速度很快。**

布隆过滤器可以**保证**集合中**不存在**元素，但它只能给出关于元素**存在**的**估计**。

因此，当它响应某个元素不存在于集合中（否定答案）时，您可以确定情况确实如此。但每 N 个肯定答案中就有一个是错误的。这种不确定性在计算机科学中仍然占有一席之地。

在很多情况下，否定答案将阻止成本更高的操作，例如检查用户名是否已被占用、信用卡是否被报告为被盗、用户是否已经看到广告等等。

| 布隆过滤器答案 | 实际情况               |
| -------------- | ---------------------- |
| 不存在         | 不存在                 |
| 存在           | 可能存在，也可能不存在 |

### 基本原理

布隆过滤器基于一个位数组和若干个哈希函数，其中位数组是一个由0和1组成的数组，**初始值全部为0**。

当一个元素加入到布隆过滤器中时，会通过多个哈希函数生成**多个哈希值**，然后将这些**哈希值对应的位数组位置设置为1**。

当一个元素要查询是否存在于布隆过滤器中时，也会通过多个哈希函数生成多个哈希值，然后查询这些哈希值对应的位数组位置是否都为1。

如果任何一个位数组位置不为1，那么该元素**肯定不存在**于布隆过滤器中。

如果所有位数组位置都为1，那么该元素**可能存在**于布隆过滤器中。

因为多个元素可能会被哈希到同一个位数组位置上，所以**存在误判**的情况，但是**不会漏掉**任何一个元素。

![img](https://gitee.com/mingzijian/resources/raw/master/picgo/2024-03/2e2eb9389b504fc231c6e024ac4e141a91ef6d91.jpeg)



### 性能表现（复杂度）

布隆过滤器中的插入是 `O(K)`，其中`K`是哈希函数的数量。

对于堆叠过滤器，检查元素的时间复杂度为 `O(K)` 或 `O(K*n)`，其中 `n` 是堆叠过滤器的数量。

### 参数配置（预设）

#### 1. 误报率 ( `error_rate`)

该比率是 0 到 1 之间的十进制值。

error_rate = 0.001  表示 误报率为 0.1% （千分之一）



#### 2. 容量（`capacity`）

capacity 是期望过滤器中的元素总数，静态集合很简单，但当集合随着时间的推移而增长时，它会变得复杂。设置合适的数值很重要，因为如果**过大**，会**浪费内存**。如果**过小**，过滤器将被**填满**，并且必须在其顶部**堆叠**一个新过滤器（子过滤器堆叠）。在过滤器由多个相互堆叠的子过滤器组成的情况下，添加的延迟保持不变，但**检查是否存在的延迟会增加**。

其原因在于检查的工作方式：首先对顶部（最新）过滤器执行常规检查，如果返回否定答案，则检查下一个过滤器，依此类推。

#### 3. 扩容缩放 （ `EXPANSION`）

数据结构“填满”不会导致向布隆过滤器中添加元素失败。但是会增加错误率。

为了使误差接近过滤器初始化时设置的误差 - 布隆过滤器将自动缩放，这意味着当达到容量时将创建一个额外的子过滤器。
新子过滤器的大小是最后一个子过滤器的大小乘以`EXPANSION`。如果过滤器中要存储的元素数量未知，我们建议您使用 2 或更多的扩展来减少子过滤器的数量。否则，我们建议您使用扩展 1 以减少内存消耗。默认扩展值为 2。

该过滤器将为每个新的子过滤器不断添加更多哈希函数，以保持您期望的错误率。

也许您想知道“如果我知道无论如何我都会扩展，为什么我要创建一个具有高扩展率的较小过滤器？”；答案是：对于需要保留许多过滤器（假设每个用户或每个产品一个过滤器）的情况，其中大多数过滤器将保持较小，但一些活动较多的过滤器必须进行扩展。

#### 4. 不缩放（`NONSCALING`）

如果确定不会扩展，请使用该`NONSCALING`标志，因为这样过滤器将减少使用一个哈希函数。

但是如果确实达到了最初分配的容量，错误率将开始增加。



## Bloom（布隆） 与 Cuckoo（布谷鸟） 过滤器

插入项目时，布隆过滤器通常会表现出更好的性能和可扩展性（因此，如果您经常向数据集添加项目，那么布隆过滤器可能是理想的选择）。Cuckoo 过滤器的检查操作速度更快，并且还允许删除。

读多写少选 Cuckoo （允许删除元素）

写多读少选 Bloom（不允许删除元素）

**布隆过滤器无法删除元素**：因为布隆过滤器的位数组中只能将元素对应的位设置为1，不能设置为0，所以无法删除元素。