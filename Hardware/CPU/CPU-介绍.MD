CPU 介绍
-------------
中央处理器 （英语：Central Processing Unit，缩写：CPU），是计算机的主要设备之一，功能主要是解释计算机指令以及处理计算机软件中的数据。

### 相关术语

1:内存屏障(memory barriers):
是一组处理器指令,用于实现对内存操作顺序的控制。

2:缓冲行(cache line):
CPU高速缓存中可以分配的最小存储单位。处理器填写缓存行时会加载整个缓存。

3:原子操作(atomic operations):
不可中断的一个操作。

4:缓存行填充(cache line fill);
当处理器识别到从内存中读取操作数是可缓存的,处理器读取整个高速缓存行到适当的缓存(L1,L2,L3)。

5:缓存命中(cache hit):
如果进行高速缓存行填充操作的内存位置是下次处理器访问地址时,处理器从缓存中读取操作数,而不是从内存中读取。

6:写命中(write hit):
当处理器将操作数写回到缓存区域时,它会首先检查这个缓存的内存地址是否在缓存行中,如果存在一个有效的缓存行,则处理器将这个操作数写回到缓存,而不是写到内存,这个操作被称为写命中。

7:写缺失(write misses the cache):
一个有效的缓存行被写入到不存在的内存区域。

8:对比交换(Compare and Swap):
CAS操作需要输入两个数值,一个是旧值,一个是修改的值。在操作期间先比较旧值有没有发生变化,如果没有交换,如果有变化则不交换。

9:CPU流水线(CPU pipeline):
CPU流水线一种将指令分解为多步，并让不同指令的各步操作重叠，从而实现几条指令并行处理，以加速程序运行过程的技术。指令的每步有各自独立的电路来处理，每完成一步，就进到下一步，而前一步则处理后续指令。

10:内存顺序冲突(Memory order violation):
内存顺序冲突一般是由假共享引起的,假共享是指多个CPU同时修改一个缓存行的不同部分而引起其中一个CPU的操作无效,当出现这个操作的时候,CPU必须清空流水线。

### 相关命令
#### LINUX

##### lscpu 查看CPU信息

```shell
$ lscpu
Architecture:          x86_64
CPU op-mode(s):        32-bit, 64-bit
Byte Order:            Little Endian
CPU(s):                16
On-line CPU(s) list:   0-15
Thread(s) per core:    2
Core(s) per socket:    8
座：                 1
NUMA 节点：         1
厂商 ID：           GenuineIntel
CPU 系列：          6
型号：              79
型号名称：        Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz
步进：              1
CPU MHz：             1307.906
BogoMIPS：            4194.91
虚拟化：           VT-x
L1d 缓存：          32K
L1i 缓存：          32K
L2 缓存：           256K
L3 缓存：           20480K
NUMA 节点0 CPU：    0-15
```
##### top
实时显示linux的任务

##### sar
收集、报告或保存系统活动信息

##### vmstat
报告关于内核线程、虚拟内存、磁盘、陷阱和 CPU 活动的统计信息。

### CPU 缓存
在计算机系统中，CPU高速缓存（CPU Cache，简称缓存）是用于减少处理器访问内存所需平均时间的部件。在金字塔式存储体系中它位于自顶向下的第二层，其速度仅次于CPU寄存器。其容量远小于内存，但速度却可以接近处理器的频率。

当处理器发出内存访问请求时，会先查看缓存内是否有请求数据。如果存在（命中），则不经访问内存直接返回该数据；如果不存在（失效），则要先把内存中的相应数据载入缓存，再将其返回处理器。

缓存之所以有效，主要是因为程序运行时对内存的访问呈现局部性（Locality）特征。这种局部性既包括空间局部性（Spatial Locality），也包括时间局部性（Temporal Locality）。有效利用这种局部性，缓存可以达到极高的命中率。

#### 缓存分级

##### 1:L1 Cache（一级缓存）
CPU第一层高速缓存，分为数据缓存和指令缓存。内置的L1高速缓存的容量和结构对CPU的性能影响较大，不过高速缓冲存储器均由静态RAM组成，结构较复杂，在CPU管芯面积不能太大的情况下，L1级高速缓存的容量不可能做得太大。
L1d是一级数据缓存，L1i是一级指令缓存。

酷睿 i7-7700HQ 的一级缓存是 256KB
Intel(R) Core(TM) i7-6700 CPU @ 3.40GHz  的一级缓存是64KB
Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz 的一级缓存是64KB

##### 2:L2 Cache（二级缓存）

CPU的第二层高速缓存，分内部和外部两种芯片。内部的芯片二级缓存运行速度与主频相同，而外部的二级缓存则只有主频的一半。L2高速缓存容量也会影响CPU的性能，原则是越大越好。

酷睿 i7-7700HQ 的二级缓存是1MB
Intel(R) Core(TM) i7-6700 CPU @ 3.40GHz  的二级缓存是256KB
Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz 的二级缓存是256KB

##### 3:L3 Cache（三级缓存）
为读取二级缓存后未命中的数据设计的—种缓存，在拥有三级缓存的CPU中，只有约5%的数据需要从内存中调用，这进一步提高了CPU的效率。

酷睿 i7-7700HQ 的三级缓存是6MB
Intel(R) Core(TM) i7-6700 CPU @ 3.40GHz  的三级缓存是8MB
Intel(R) Xeon(R) CPU E5-2620 v4 @ 2.10GHz 的三级缓存是20MB
AMD EPYC（霄龙）7742 的三级缓存是256MB

### 寄存器
寄存器是CPU的内部组成单元,是CPU运算时取指令和数据的地方，速度很快，可以理解为对于CPU来说读/写寄存器是不需要时间的，或者说如果只是操作寄存器（比如类似mov BX,AX之类的操作），那么一秒钟执行的指令个数理论上说就等于主频，因为寄存器是CPU的一部分。

寄存器可以用来暂存指令、数据和地址。
在CPU中，通常有
- 通用寄存器，如指令寄存器IR；
- 特殊功能寄存器，如程序计数器PC、sp等。

### CPU时钟周期
CPU时钟周期是操作的最小时间单位，值是主频的倒数，现代计算机的主频可以达到几GHZ。

指令周期是取出并执行一个指令的时间单位，一个指令需要多个CPU操作来执行，一般来说一个指令周期至少包含2个CPU时钟周期（取指+执行）。

同一个硬件架构下不同CPU的时钟周期越高，相同时间内能够执行的指令就越多，性能就越好；但在不同的硬件架构下只比较CPU主频大小意义不大，处理器结构不同，指令集就不同，相同意义的指令所需的CPU时钟周期也就不同。

### CPU的位和字长
#### 位：
在数字电路和计算机技术中采用二进制，代码只有“0”和“1”，其中无论是 “0”或是“1”在CPU中都是 一“位”。
#### 字长：
计算机技术中对CPU在单位时间内(同一时间)能一次处理的二进制数的位数叫字长。所以能处理字长为8位数据的CPU通常就叫8位的CPU。同理32位的CPU就能在单位时间内处理字长为32位的二进制数据。字节和字长的区别：由于常用的英文字符用8位二进制就可以表示，所以通常就将8位称为一个字节。字长的长度是不固定的，对于不同的CPU、字长的长度也不一样。8位的CPU一次只能处理一个字节，而32位的CPU一次就能处理4个字节，同理字长为64位的CPU一次可以处理8个字节。