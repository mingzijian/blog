IP (Internet Protocol)
---------------------------------
互联网协议。

### 结构
IP地址由**网络地址**与**主机地址**两部分所组成。

#### 网络地址
网络地址指的是互联网上的节点在网络中具有的逻辑地址,可对节点进行寻址。
如：A类地址的前8位，B类地址的前16位，C类地址的前24位

#### 主机地址
主机地址指的是IP地址右边部分用来标识主机本身的部分。
如：A类地址的后32位，B类地址的后16位，C类地址的后8位

#### 子网掩码
子网掩码(subnet mask)又叫网络掩码、地址掩码、子网络遮罩，它是一种用来指明一个IP地址的哪些位标识的是主机所在的子网，以及哪些位标识的是主机的位掩码。
子网掩码不能单独存在，它必须结合IP地址一起使用。
子网掩码的唯一作用就是将某个IP地址划分成网络地址和主机地址两部分。

##### 计算方式
由于子网掩码的位数决定于可能的子网数目和每个子网的主机数目。
在定义子网掩码前，必须弄清楚本来使用的子网数和主机数目。

- 根据子网数
  1. 将子网数（十进制）转化为二进制表示，记为a
  2. 取得该二进制a的位数，记为n
  3. 取得该ip地址的类子网掩码（默认），将其主机地址部分的前n位全部置为1即得到子网掩码
  

示例：将B类IP地址`168.195.0.0`划分成27个子网
  1. 十进制 27 的二进制表示 11011，a=11011
  2. a的位数为5，n=5
  3. B类IP地址子网掩码为`255.255.0.0`，二进制表示为：11111111.11111111.00000000.00000000 ，将其主机地址部分的前5位全部置为1：11111111.11111111.11111000.00000000，二进制11111000的十进制表示为：128+64+32+16+8=248，最终得到的子网掩码为：`255.255.248.0`。
即为划分成27个子网的B类IP地址 `168.195.0.0`的子网掩码`255.255.248.0`实际上是划成了32个子网。
- 根据主机数
  1. 将主机数目（十进制，注意去掉保留地址）转化为二进制来表示，记为a
  2. 取得该主机数的二进制位数，记为n
  3. 使用`255.255.255.255`来将该类IP地址的主机地址位数全部置1，然后将从右向左的n位全部置为 0 得到子网掩码。

示例：将B类IP地址`168.195.0.0`划分成若干子网，每个子网内有主机700台
  1.  十进制 700 的二进制表示1010111100，a=1010111100
  2.  取得该主机数的二进制位数，n=10
  3.  将`255.255.255.255`的右10位全部置为0，即：11111111.11111111.11111100.00000000，得到的点分十进制子网掩码表示为：`255.255.252.0`

### 分类
#### A类/B类/C类

| 概念    | 特征                             | 网络范围      | 默认掩码         |
| :------ | :------------------------------- | :------------ | :--------------- |
| A类地址 | 第1个8位中的第1位始终为0         | 0-127.x.x.x   | 255.0.0.0/8      |
| B类地址 | 第1个8位中的第1、2位始终为10     | 128-191.x.x.x | 255.255.0.0/16   |
| C类地址 | 第1个8位中的第1、2、3位始终为110 | 192-y.x.x.x   | 255.255.255.0/24 |

#### D类/E类
##### D类
组播地址

- 永久组播
由官方分配
224.0.0.0～224.0.0.255为预留的组播地址

- 临时组播
224.0.2.0～238.255.255.255为用户可用的组播地址


组播地址列表
- `224.0.0.0` 基准地址（保留）
- `224.0.0.1` 所有主机的地址 （包括所有路由器地址）
- `224.0.0.2` 所有组播路由器的地址
- `224.0.0.3` 不分配
- `224.0.0.4` dvmrp路由器
- `224.0.0.5` 所有ospf路由器
- `224.0.0.6` ospf DR/BDR
- `224.0.0.7` st路由器
- `224.0.0.8` st主机
- `224.0.0.9` rip-2路由器
- `224.0.0.10` Eigrp路由器
- `224.0.0.11` 活动代理
- `224.0.0.12` dhcp 服务器/中继代理
- `224.0.0.13` 所有pim路由器
- `224.0.0.14` rsvp封装
- `224.0.0.15` 所有cbt路由器
- `224.0.0.16` 指定sbm
- `224.0.0.17` 所有sbms
- `224.0.0.18` vrrp
- `224.0.0.22` IGMPv3

##### E类
保留地址
- A类保留地址：10.0.0.0 ~ 10.255.255.255
- B类保留地址：172.16.0.0 ~ 172.31.255.255
- C类保留地址：192.168.0.0 ~ 192.168.255.255

### 特殊IP地址

| [CIDR](https://baike.baidu.com/item/CIDR)地址块 | 描述                                                       | 参考资料                                          |
| ----------------------------------------------- | ---------------------------------------------------------- | ------------------------------------------------- |
| 0.0.0.0/8                                       | 本网络（仅作为源地址时合法）                               | RFC 5735                                          |
| 10.0.0.0/8                                      | [专用网络](https://baike.baidu.com/item/专用网络)          | [RFC 1918](https://baike.baidu.com/item/RFC 1918) |
| 100.64.0.0/10                                   | [电信级NAT](https://baike.baidu.com/item/电信级NAT)        | RFC 6598                                          |
| 127.0.0.0/8                                     | [环回](https://baike.baidu.com/item/环回)                  | RFC 5735                                          |
| 169.254.0.0/16                                  | 链路本地                                                   | RFC 3927                                          |
| 172.16.0.0/12                                   | [专用网络](https://baike.baidu.com/item/专用网络)          | [RFC 1918](https://baike.baidu.com/item/RFC 1918) |
| 192.0.0.0/24                                    | 保留（IANA）                                               | RFC 5735                                          |
| 192.0.2.0/24                                    | TEST-NET-1，文档和示例                                     | RFC 5735                                          |
| 192.88.99.0/24                                  | [6to4](https://baike.baidu.com/item/6to4)中继              | RFC 3068                                          |
| 192.168.0.0/16                                  | [专用网络](https://baike.baidu.com/item/专用网络)          | [RFC 1918](https://baike.baidu.com/item/RFC 1918) |
| 198.18.0.0/15                                   | 网络基准测试                                               | RFC 2544                                          |
| 198.51.100.0/24                                 | TEST-NET-2，文档和示例                                     | RFC 5737                                          |
| 203.0.113.0/24                                  | TEST-NET-3，文档和示例                                     | RFC 5737                                          |
| 224.0.0.0/4                                     | [多播](https://baike.baidu.com/item/多播)（之前的D类网络） | RFC 3171                                          |
| 240.0.0.0/4                                     | 保留（之前的E类网络）                                      | RFC 1700                                          |
| 255.255.255.255                                 | 受限广播                                                   | RFC 919                                           |

#### 名词解释
- CIDR （Classless Inter-Domain Routing）
无类别域间路由。
是一个用于给用户分配IP地址以及在互联网上有效地路由IP数据包的对IP地址进行归类的方法。

### 协议版本
#### IPv4
互联网协议第4版（Internet Protocol version4，IPv4）。

##### 地址长度及地址数量
地址长度：32位（4字节）
地址数量：2^32（约4.3×10^9，即43亿）个

#### IPv6
互联网协议第6版（Internet Protocol version6，IPv6）。

由于IPv4最大的问题在于网络地址资源不足，严重制约了互联网的应用和发展。
互联网工程任务组（IETF）设计出了IPv6，用于替代IPv4，IPv6地址数量号称可以为全世界的每一粒沙子编上一个地址 。
##### 地址长度及地址数量
地址长度：128位（16字节）
地址数量：2^128（约3.4×10^38）个

### 报文格式
一个IP数据报由**首部**和**数据**两部分组成。
#### 首部

 ![img](https://gitee.com/mingzijian/resources/raw/master/picgo/IP-format.png)

| 字段                             | 长度   | 含义                                                         |
| -------------------------------- | ------ | ------------------------------------------------------------ |
| Version<br/>版本                 | 4比特  | 4：表示为IPV4；6：表示为IPV6。                               |
| IHL<br/>首部长度                 | 4比特  | 首部长度，如果不带Option字段，则为20，最长为60，该值限制了记录路由选项。以4字节为一个单位。 |
| Type of Service<br/>服务类型     | 8比特  | 服务类型。只有在有QoS差分服务要求时这个字段才起作用。        |
| Total Length<br/>总长度          | 16比特 | 总长度，整个IP数据报的长度，包括首部和数据之和，单位为字节，最长65535，总长度必须不超过最大传输单元MTU。 |
| Identification<br/>标识          | 16比特 | 标识，主机每发一个报文，加1，分片重组时会用到该字段。        |
| Flags<br/>标志位                 | 3比特  | 标志位 IP Flag字段格式 ![IP-format-flag](https://gitee.com/mingzijian/resources/raw/master/picgo/IP-format-flag.png) <br/>Bit 0: 保留位，必须为0。<br/>Bit 1: DF（Don't Fragment），能否分片位，0表示可以分片，1表示不能分片。<br/>Bit 2: MF（More Fragment），表示是否该报文为最后一片，0表示最后一片，1代表后面还有。 |
| Fragment Offset<br/>片偏移       | 12比特 | 片偏移：分片重组时会用到该字段。表示较长的分组在分片后，某片在原分组中的相对位置。以8个字节为偏移单位。 |
| Time to Live<br/>生存时间        | 8比特  | 生存时间：可经过的最多路由数，即数据包在网络中可通过的路由器数的最大值。 |
| Protocol<br/>协议                | 8比特  | 协议：下一层协议。指出此数据包携带的数据使用何种协议，以便目的主机的IP层将数据部分上交给哪个进程处理。常见值：<br/>0: 保留Reserved<br/>1: ICMP, Internet Control Message [RFC792]<br/>2: IGMP, Internet Group Management [RFC1112]<br/>3: GGP, Gateway-to-Gateway [RFC823]<br/>4: IP in IP (encapsulation) [RFC2003]<br/>6: TCP Transmission Control Protocol [RFC793]<br/>17: UDP User Datagram Protocol [RFC768]<br/>20: HMP Host Monitoring Protocol [RFC 869]<br/>27: RDP Reliable Data Protocol [ RFC908 ]<br/>46: RSVP (Reservation Protocol)<br/>47: GRE (General Routing Encapsulation)<br/>50: ESP Encap Security Payload [RFC2406]<br/>51: AH (Authentication Header) [RFC2402]<br/>54: NARP (NBMA Address Resolution Protocol) [RFC1735]<br/>58: IPv6-ICMP (ICMP for IPv6) [RFC1883]<br/>59: IPv6-NoNxt (No Next Header for IPv6) [RFC1883]<br/>60: IPv6-Opts (Destination Options for IPv6) [RFC1883]<br/>89: OSPF (OSPF Version 2) [RFC 1583]<br/>112: VRRP (Virtual Router Redundancy Protocol) [RFC3768]<br/>115: L2TP (Layer Two Tunneling Protocol)<br/>124: ISIS over IPv4<br/>126: CRTP (Combat Radio Transport Protocol)<br/>127: CRUDP (Combat Radio User Protocol)<br/>132: SCTP (Stream Control Transmission Protocol)<br/>136: UDPLite [RFC 3828]137: MPLS-in-IP [RFC 4023] |
| Header Checksum<br/>首部校验和   | 16比特 | 首部校验和，只检验数据包的首部，不检验数据部分。这里不采用CRC检验码，而采用简单的计算方法。 |
| Source Address<br/>源地址        | 32比特 | 源IP地址。                                                   |
| Destination Address<br/>目的地址 | 32比特 | 目的IP地址。                                                 |
| Options<br/>选项                 | 可变   | 选项字段，用来支持排错，测量以及安全等措施，内容丰富。选项字段长度可变，从1字节到40字节不等，取决于所选项的功能。 |
| Padding<br/>填充                 | 可变   | 填充字段，对齐，全填0。                                      |


#### 数据

可选数据